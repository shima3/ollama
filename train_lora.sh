#!/bin/bash

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã«å®Ÿè¡Œã‚’åœæ­¢
set -e

# ä½¿ç”¨æ–¹æ³•ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
usage() {
  echo "Usage: $0 <output_dir> <base_model> <dataset> --target-modules \"<modules>\" [OPTIONS]"
  echo
  echo "This script automates the entire process: training, GGUF conversion,"
  echo "and creating the final Ollama model."
  echo
  echo "Arguments:"
  echo "  <output_dir>          Directory for artifacts. Renames old one if exists."
  echo "  <base_model>          Base model name or path."
  echo "  <dataset>             Path to the training dataset JSON file."
  echo
  echo "Required Options:"
  echo "  --target-modules \"...\"  Comma-separated list of target modules for LoRA."
  exit 1
}

# å¼•æ•°ã®æ•°ã‚’ãƒã‚§ãƒƒã‚¯
if [ "$#" -lt 4 ]; then
  usage
fi

OUTPUT_DIR="$1"
BASE_MODEL="$2"
ORIGINAL_DATASET_PATH="$3"

# æ—¢å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†
if [ -d "$OUTPUT_DIR" ]; then
    echo "Warning: Directory '$OUTPUT_DIR' already exists. It will be renamed."
    TIMESTAMP_SUFFIX=""
    if [ "$(uname)" == "Darwin" ]; then CREATION_TIMESTAMP=$(stat -f %B "$OUTPUT_DIR"); TIMESTAMP_SUFFIX=$(date -r "$CREATION_TIMESTAMP" +'%Y%m%d-%H%M%S');
    elif [ "$(uname)" == "Linux" ]; then
        if stat -c %W "$OUTPUT_DIR" > /dev/null 2>&1 && [ "$(stat -c %W "$OUTPUT_DIR")" != "0" ]; then CREATION_TIME_STR=$(stat -c %w "$OUTPUT_DIR"); else echo "  (Note: Birth time not available. Using modification time.)"; CREATION_TIME_STR=$(stat -c %y "$OUTPUT_DIR"); fi
        TIMESTAMP_SUFFIX=$(date -d "$CREATION_TIME_STR" +'%Y%m%d-%H%M%S'); fi
    if [ -n "$TIMESTAMP_SUFFIX" ]; then RENAMED_DIR="${OUTPUT_DIR}-${TIMESTAMP_SUFFIX}"; echo "         Renaming existing directory to '$RENAMED_DIR'"; mv "$OUTPUT_DIR" "$RENAMED_DIR"; else echo "Error: Could not determine directory timestamp to rename."; exit 1; fi
fi

if [ ! -f "$ORIGINAL_DATASET_PATH" ]; then echo "Error: Dataset file not found at '$ORIGINAL_DATASET_PATH'"; exit 1; fi

echo -e "\nCreating new output directory '$OUTPUT_DIR'..."
mkdir -p "$OUTPUT_DIR"

# ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®é…ç½® (ãƒãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ or ã‚³ãƒ”ãƒ¼)
TARGET_DATASET_PATH="$OUTPUT_DIR/dataset.json"
echo -e "\nPlacing dataset into output directory as 'dataset.json'..."
if ln "$ORIGINAL_DATASET_PATH" "$TARGET_DATASET_PATH" 2>/dev/null; then echo "  âœ… Successfully created hard link."; else echo "  âš ï¸ Hard link failed. Falling back to copy."; cp "$ORIGINAL_DATASET_PATH" "$TARGET_DATASET_PATH"; echo "  âœ… Successfully copied dataset."; fi
ABS_ORIGINAL_DATASET_PATH=$(cd "$(dirname "$ORIGINAL_DATASET_PATH")" && pwd)/$(basename "$ORIGINAL_DATASET_PATH")

shift 3

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
PYTHON_SCRIPT="$SCRIPT_DIR/train_lora.py"
if [ ! -f "$PYTHON_SCRIPT" ]; then echo "Error: train_lora.py not found."; exit 1; fi

echo "=================================================="
echo "Output Directory:   $OUTPUT_DIR"
echo "Base model:         $BASE_MODEL"
echo "Original Dataset:   $ABS_ORIGINAL_DATASET_PATH"
echo "Other arguments:    $@"
echo "=================================================="

cd "$OUTPUT_DIR"

echo -e "\n--- Step 1: Executing Python script for model building ---"
if command -v python3 &> /dev/null; then
    python3 "$PYTHON_SCRIPT" "$BASE_MODEL" "$@"
else
    python "$PYTHON_SCRIPT" "$BASE_MODEL" "$@"
fi
echo "--- Python script finished ---"

echo -e "\n--- Step 2: Finalizing training_info.txt ---"
echo "  dataset_original_path: $ABS_ORIGINAL_DATASET_PATH" >> training_info.txt
echo "âœ… Appended original dataset path to training_info.txt"

# --- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒæ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼ ---
echo -e "\n--- Step 3: Creating and executing Ollama model script ---"
MODEL_TAG="$(basename "$(pwd)"):latest"

# create_ollama_model.sh ã‚’ã“ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½œæˆã™ã‚‹
cat > create_ollama_model.sh << EOF
#!/bin/sh
# This script was auto-generated by train_lora.sh
cd "\$(dirname "\$0")"
ollama create $MODEL_TAG -f Modelfile
echo "âœ… Ollama model '$MODEL_TAG' created successfully."
EOF
chmod +x create_ollama_model.sh

echo "âœ… Created executable script: ./create_ollama_model.sh"
echo "Executing it now to create model: $MODEL_TAG"

# ä½œæˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å³åº§ã«å®Ÿè¡Œ
./create_ollama_model.sh
# --- â–²â–²â–² æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ â–²â–²â–² ---

echo -e "\nğŸ‰ All processes completed successfully!"
if [ -n "$RENAMED_DIR" ]; then
    echo "The previous run was archived to '${RENAMED_DIR}'."
fi